
    <!DOCTYPE html>
    <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
    <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
    <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
    <!--[if gt IE 8]>      <html class="no-js"> <![endif]-->
    <html>
        <head>
            <meta charset="utf-8">
            <meta http-equiv="X-UA-Compatible" content="IE=edge">
            <title>making a lethal company mod - vegemike.github.io</title>
            <meta name="description" content="i noticed after the latest v70 lethal company update some of my QOL mods stopped working, and when, even after a day or two, there was no update i was like hey i can make my own it cant be that hard surely so i">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta property="og:title" content="making a lethal company mod - vegemike.github.io">
            <meta property="og:description" content="i noticed after the latest v70 lethal company update some of my QOL mods stopped working, and when, even after a day or two, there was no update i was like hey i can make my own it cant be that hard surely so i">
            <meta property="og:image" content="https://vegemike.github.io/assets\techstuff\lethalmodding\boombox\BoomboxIcon.webp">
            <meta property="og:url" content="https://vegemike.github.io/main/tech/making-a-lethal-company-mod">
            <meta property="og:type" content="article">
            <link rel="stylesheet" href="../../../styles/reviews/terminal.css">
            <div id="pathToGenerator" style="display:none;">moddinglc.mike</div>
        </head>
        <body>
            <div id="everything" style="position: absolute; left: -999999px;opacity:1%;">['making a lethal company mod', '\nvery fun!!&\n <IMG="assets\\techstuff\\lethalmodding\\boombox\\BoomboxIcon.webp"> \ni noticed after the latest v70 lethal company update some of my QOL mods stopped working, and when, even after a day or two, there was no update i was like hey i can make my own it cant be that hard surely \\n \nso i got to it and looked at some startup guides and realised it was in C# which was (until now) completely beyond me (it still really is). regardless, i installed rider and the project template and got going. \nthe weirdest part was understanding all the libraries and stuff. it\'s built with unity so like theres all the unity methods and classes to work with and like it mainly hinges around harmony. \nharmony is a library that basically allows you to hook into and modify methods. i very shortly realised that those QOL mods were way beyond me\ni first wanted to go for a boombox mod, one that would play songs i choose on the boombox instead of the 5 default ones \n(;) \n(**modding_the_boombox**) \nfirst step is to see how the boombox works. this is pretty easy with using dotPeek to decompile the main game assembly, "Assembly-CSharp.dll". \nmost of the stuff under the BoomboxItem class is irrelevant, but a few things stick out:\nthis declaration - \'\'\'  public AudioSource boomboxAudio; public AudioClip[] musicAudios; public AudioClip[] stopAudios; public System.Random musicRandomizer; \'\'\' \nand the following method: \n \n\'\'\' \n  private void StartMusic(bool startMusic, bool pitchDown = false)\n  {\n    if (startMusic)\n    {\n      this.boomboxAudio.clip = this.musicAudios[this.musicRandomizer.Next(0, this.musicAudios.Length)];\n      this.boomboxAudio.pitch = 1f;\n      this.boomboxAudio.Play();\n    }\n    else if (this.isPlayingMusic)\n    {\n      if (pitchDown)\n      {\n        this.StartCoroutine(this.musicPitchDown());\n      }\n      else\n      {\n        this.boomboxAudio.Stop();\n        this.boomboxAudio.PlayOneShot(this.stopAudios[UnityEngine.Random.Range(0, this.stopAudios.Length)]);\n      }\n      this.timesPlayedWithoutTurningOff = 0;\n    }\n    this.isBeingUsed = startMusic;\n    this.isPlayingMusic = startMusic;\n  }\n \'\'\' \n\nso all that needs to be done is to overwrite the boomboxAudio.clip to whatever song id like, and .Play(). pretty easy. \n(**modifying_the_StartMusic()_method_(singleplayer)**) \nusing harmony, we want to append code to the END of the method, done like so: \n\'\'\' \n[HarmonyPatch(typeof(BoomboxItem))]\n[HarmonyPatch("StartMusic", MethodType.Normal)] \nclass LaDeDaDeDaBoomboxPatch\n{\n    static void Postfix(BoomboxItem __instance, bool startMusic)\n    {\n    }\n} \n\'\'\' \nany code in the Postfix method gets run AFTER the StartMusic() method.\ntaking the current BoomboxItem as __instance we can directly configure the specific boombox that is running the StartMusic() method.\nnext step is to embed the song i want to play (i don\'t like having extra files about the place), so i set a file "song.wav" to build as an EmbeddedResource.\nthis file can then be accessed through \n \n\'\'\' \nvar assembly = Assembly.GetExecutingAssembly();\nvar resourceName = "LaDeDaDeDaBoombox.Assets.song.wav"; \nbyte[] wavBytes;\nusing (Stream stream = assembly.GetManifestResourceStream(resourceName) //grab embedded wav file)\n    {\n        wavBytes = new byte[stream.Length]; //prepare container for the wav\n        stream.Read(wavBytes, 0, wavBytes.Length); // load the PCM into the container\n    }\n// convert those bytes into an AudioClip\nAudioClip clip = WavUtility.ToAudioClip(wavBytes, 0, "EmbeddedSong");\n \'\'\' \n\nplease note i am using WavUtility to decode the wav file \\n \nand then, easily, to play:\n\n \'\'\' \nboombox.boomboxAudio.clip = clip;\nboombox.boomboxAudio.Play();\n \'\'\' \n\nmake sure it all gets patched at startup: \n\n \'\'\' \n[BepInEx.BepInPlugin("com.vegemike.LaDeDaDeDaBoombox", "Boombox Patch", "1.0.0")]\npublic class BoomboxMod : BaseUnityPlugin\n{\n    private void Awake()\n    {\n        var harmony = new Harmony("com.vegemike.LaDeDaDeDaBoombox");\n        Harmony.CreateAndPatchAll(typeof(LaDeDaDeDaBoomboxPatch));\n    }\n}\n \'\'\' \n\nbuild, place the dll in the BepInEx\\plugins\\ folder and it works nicely. \n(;) \n(**adding_more_songs**) \nactually was very easy to add more songs. considering space requirements, i switched from wav to ogg, which is supported just as much and is actually compressed (don\'t want my plugin being 5 gigs). it also means we don\'t need WavUtility anymore which is nice. \n\n \'\'\' \nvar assembly = Assembly.GetExecutingAssembly(); //same as before\nstring prefix = "LaDeDaDeDaBoombox.Assets."; //because we\'re accessing multiple resources (and using this a few times), it\'s easier now to store this prefix separately \nvar songs = assembly.GetManifestResourceNames()\n            .Where(name => name.StartsWith(prefix) && name.EndsWith(".ogg")) //only take the embedded resources that are within Assets and are .ogg files\n            .ToArray(); //make this a list. \n\'\'\' \n\ncool, now there\'s a list of all the available embedded songs, just pick one (randomly?) and play it? but wait: for the sake of processing speeds, i decided to cache the songs when they get played (\\plugins\\cached_songs\\) \nfirst, make the directory: \n \n\'\'\' string cacheDir = Path.Combine(Paths.PluginPath, "cached_songs");\nDirectory.CreateDirectory(cacheDir); \'\'\' \nand check if the file has been cached yet:\n \'\'\' string cachedPath = Path.Combine(cacheDir, songFileName /*we\'ll sort this later*/); \n if (!File.Exists(cachedPath)) {\n    //do stuff\n } \'\'\' \n\nif it has, nice, just load it: \n\n \'\'\' \nusing var request = UnityWebRequestMultimedia.GetAudioClip("file://" + cachedPath, AudioType.OGGVORBIS); \nyield return request.SendWebRequest(); \nAudioClip clip = DownloadHandlerAudioClip.GetContent(request); \n\'\'\' \n\nand play it as before.\nif not, though, it has to be cached. if the file DOESN\'T exist:  \n\n \'\'\' \nusing var stream = assembly.GetManifestResourceStream(chosenResource);\nusing var fileStream = File.Create(cachedPath);\nstream.CopyTo(fileStream); \n\'\'\' \n\nand then continue to load the song as normal.\n \\n \nchoosing the song: \n\n \'\'\'  \nstring chosenResource = songs[UnityEngine.Random.Range(0, songs.Length)];\nstring songFileName = chosenResource.Substring(prefix.Length);  \n\'\'\' \n\neasy! (;) \none issue: when playing with friends (who also have the mod), sure they hear music, just not the same song as i or any other player. this is the hardest part of the entire project \n(**NETWORKING!!_getting_songs_to_sync_cross-client**) \nquickly, before doing scary network stuff, the boombox plays the original music before the songs i\'ve chosen. easy fix, just by putting \'\' __instance.boomboxAudio.Stop(); \'\' at the top of the Postfix patch.\n \\n \nokay, networking. \\n \\n \nthe first step is to set out the logic: \n\'\'\' \nwhen boombox is played:\n1. choose song somehow \n2. send song name to everyone in the server somehow\n3. get everyone else\'s to play that song \n4. happiness \n\'\'\' \n \\n \n(**step_1:_choosing_a_song_(as_host)**) \nfirst issue: who should choose the song? if everyone connected does so, it\'ll get all messy. the obvious solution is to have only the host choose the song. \nlethal company uses NetworkManager (accessible globally), which has the handy property of .IsHost. so: \n\'\'\' \nboombox on:\nam i host?\nif yes:\n    pick a song\n    tell everyone\nif no:\n    wait for the host to tell me what song to play\n \'\'\' \nwhich, in c#, should look a little like:\n\n \'\'\' \nif (NetworkManager.Singleton.IsServer || NetworkManager.Singleton.IsHost)\n        {\n            BoomboxSyncManager.Instance.HandleBoomboxStart(__instance);\n        }\n \'\'\' \n\nand would go in the startMusic Postfix. \nokay, lets sort that HandleBoomboxStart(). for the scope of picking a song, it\'s identical to before. it only changes for the next step: \n(**step_2:_announcing_chosen_song_to_clients**) \nNetworkManager has another handy property, .ConnectedClientsIds. we can just form this to a list and send a message to each client somehow. \nwe can form the list like so: \n\'\'\' \nList<ulong> clientList = NetworkManager.Singleton.ConnectedClientsIds.ToList(); \n\'\'\' \nokay, that\'s easy. it\'s harder to send the song names though. \n\\n \nright, sending stuff. \nfirst, let\'s store the boombox\'s ID, so we can tell the clients which boombox to play the sound from: \n\'\'\' ulong boomboxNetworkId = boombox.NetworkObjectId; \'\'\' \nwe\'ll use FastBufferWriter to prepare and send the song name. to set up a new one, it is done as so: \n\'\'\' \nusing var writer = new FastBufferWriter(sizeof(ulong) + 512, Allocator.Temp); \n\'\'\' \nlet\'s break it down:\nwe write \'\' using var writer \'\' so that with "using" the buffer gets disposed of afterwards, regardless of what happens. \\n \\n \npassing \'\' sizeof(ulong) + 512 \'\' sets the size, which is the size of one ulong type and an extra 512 bytes. the ulong is to store the boombox ID from earlier, and we reserve 512 for the song name. \\n \n \\n finally, we pass \'\' Allocator.Temp \'\' as the allocation strategy, which means it won\'t persist past the current frame. \\n \n \\n \nwith this set up, we can write the information to this new buffer: \n\'\'\' \nwriter.WriteValueSafe(chosenSongName);\nwriter.WriteValueSafe(boomboxNetworkId); \n\'\'\' \nso, now to send it across. we have our message buffered (writer), and a list of recipients (clientList), so how can we send it all over? \nwell, it turns out that the CustomMessagingManager of the NetworkManager is capable of this. sending it over is done like so: \n\'\'\' \nNetworkManager.Singleton.CustomMessagingManager.SendNamedMessage(\n    "BoomboxPlay",\n    clientList,\n    writer,\n    NetworkDelivery.Reliable\n    ); \n\'\'\' \nwhat does this do? well, it\'s actually not as crazy as previously alluded: \\n \n"BoomboxPlay" is the name of the NamedMessage (crazy) and so is passed first. \\n \\n \nnext, we send the \'\' clientList \'\' through, and Unity deals with sending the message to everyone in this list \\n \\n \nnext is our message (messageStream), the previously made \'\' writer \'\' of type FastBufferWriter. it HAS to be a FastBufferWriter. \\n \\n \nfinally, the networkDelivery method to send it. \'\' Reliable \'\' means it WILL reach its target, just a little slower than sending it unreliably. we can\'t risk the message not being sent, so we must send it reliably. \\n \\n \ncool! we\'ve sent the message. now, we just have to receive it! fun! \n \\n \n(**step_3:_receiving_and_playing_the_chosen_song_(as_a_client)**) \nthe first step is to prepare the clients for when the receive the message with the name BoomboxPlay. we do this easily, just by: \n\'\'\' \nNetworkManager.Singleton.CustomMessagingManager.RegisterNamedMessageHandler(\n                "BoomboxPlay",\n                OnReceiveBoomboxPlayMessage\n            ); \n \'\'\' \nthis runs the OnReceiveBoomboxPlayMessage when it receives a message by the name of BoomboxPlay. we register this handler in the Awake() method. \nnow lets set up that function \n\'\'\' private void OnReceiveBoomboxPlayMessage(ulong senderClientId, FastBufferReader reader) \'\'\' \nwe read the values in the buffer as so: \n\'\'\' \nreader.ReadValueSafe(out string songName);\nreader.ReadValueSafe(out ulong boomboxNetworkId); \n\'\'\' \nthen, easily: \n\'\'\' \nboombox.StartCoroutine(PlayClipFromResource(boombox, songName)); \n\'\'\' \nand that\'s it. \n(;) \n(**closing_remarks**) \nthere\'s a lot of finicky stuff i\'ve overlooked here. you can skim the most up-to-date source code at my github a:https://github.com/vegemike/LaDeDaDeDaBoombox which is also where you can download the binary.\nthank you for reading!!']</div>
            <div class="terminal">
                <div class="header">
                    <p>mOS VERSION 311.24.2.71828</p>
                    <!--<p>COPYRIGHT 2024 KBPRecords</p>-->
                    <p>Server 8</p>
                    <p>mouse-over or use up/down and enter</p>
                    <p id="titley">techy projects</p>
                </div>
                <div class="content" id="commands">
                </div>
                <div id="textHere">
                </div>
                <div class="footer">
                    <p>thanks for visiting</p>
                </div>
            </div>
            <!--[if lt IE 7]>
                <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
            <![endif]-->
            
            <script src="../../../scripts/parser.js" defer></script>
            <script src="../../../scripts/terminal.js" defer></script>
        </body>
    </html>
    